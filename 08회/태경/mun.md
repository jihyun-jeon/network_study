# 11장. 클라이언트 식별과 쿠키

### HTTP 무상태성 Stateless

- HTTP는 통신 규약일 뿐이므로, 서버나 클라이언트의 상태를 저장하지 않는다.
- 장바구니 기능같은 경우 상태 유지하지 위해서 상태를 저장해둬야 한다.

이처럼 특정 상태나 사용자 식별 상태를 저장하는 곳은 밑과 같은 예시들이 있다.

#### 1. HTTP 헤더

- Authorization : 주로 JWT 토큰을 주고 받는 헤더.
- From : 이메일 주소를 포함하는 헤더. (단점: 스팸메일 발송 문제)
- User-Agent : 사용자 브라우저명, 버전, 운영체제 정보 포함하여 서버에 전송
- Referer : 링크를 타고 온 이전 웹 페이지 URL

#### 2. 클라이언트 IP 주소

: 사용자 식별에 IP주소를 사용하는 방법이 있지만 약점이 존재한다.

단점

- 다수의 사용자가 같은 컴퓨터 사용시 식별 불가
- 인터넷 서비스 제공자(ISP)는 로그인 시 매번 동적 IP 주소 할당받으므로 식별 불가
- 방화벽 사용 시 식별불가
- 프락시 서버와 게이트웨이 시 IP가 다르므로 문제 발생

#### 3. Authorization 헤더

: 로그인 후 Authorization 헤더에 토큰 담은 요청을 보내 서버에서 사용자 식별하도록 하는 방법

#### 4. 뚱뚱한 URL

: URL에 상태를 추가해서 저장하는 방식으로 URL 길이가 점점 길어진 방식을 말한다. 현재는 권장되지 않는 방식이다.

#### 5. 쿠키

- 키와 값이 있는 파일, 4kb 제한용량
- 서버에서 set-cookie하면 매 요청에 자동으로 쿠키가 담겨서 전송된다.

1. **일반 쿠키**

   : HTTP 요청은 무상태성이기 때문에 서버는 웹 브라우저에 정보를 저장해둔다.

2. **세션 쿠키**

   : 서버가 접속상태를 가지고, 세션 ID를 클라이언트에 쿠키로 전송

   1. 세션 쿠키 (Session Cookie)
      - MaxAge나 Expires 옵션이 없는 쿠키로, 브라우저를 종료하면 쿠키는 삭제됨
   2. 영속성 쿠키 (Persistent Cookie)
      - MaxAge나 Expires 옵션이 있는 쿠키로, 브라우저의 종료 여부와 상관없이 지정된 유효시간만큼 쿠키 사용가능

### 쿠키 옵션

#### 1. Domain

: 쿠키 접근 가능한 도메인 지정. 도메인 옵션과 서버의 도메인이 일치해야 쿠키 전송 가능

- 도메인
  : 요청 URL `http://www.localhost.com:3000/users/login` 면 여기서 Domain은 `localhost.com`

#### 2. Path

: 서버가 라우팅할 때 사용하는 경로로 쿠키가 접근할 수 있는 경로

- 요청 URL이 `http://www.localhost.com:3000/users/login` 인 경우라면 Path는 `/users/login`이 됩니다.

- 기본값은 /
- 설정된 경로의 하위 경로까지만 쿠키 접근 가능
  - ex) Path - /users,
    - 요청 세부경로 - /users/codestates 면 => 쿠키 전송 가능
    - 요청 세부경로 - /posts/codestates는
    - Path 옵션(/users)이 달라서 => 쿠키 전송 불가

#### 3. Secure

- Secure 옵션이 true, HTTPS 일때만 쿠키를 전송 가능
- Secure 옵션이 없다면, HTTP 나 HTTPS 모두 쿠키 전송 가능

#### 4. HttpOnly

: 자바스크립트에서 브라우저의 쿠키에 접근 여부를 결정

- 옵션이 true인 경우, 자바스크립트에서 쿠키 접근불가
- 기본값은 false,
  `document.cookie`를 이용해 자바스크립트에서 쿠키접근이 가능하므로 XSS 공격에 취약

#### 5. SameSite

: 같은 도메인에서만 쿠키 전송 가능 → CSRF 공격 막기 위한 옵션

- lax - GET에선 쿠키 전송가능, 다른 도메인으로 전송 불가
- strict - 동일 도메인일때만 전송 가능
- none - 도메인 달라도 전송 가능하고 secure 옵션 붙여야 작동함

### 쿠키로 상태 유지

- HTTP 무상태성으로 인한 연결을 Stateful하게 유지 가능해짐
- secure옵션으로 HTTPS으로만 접속 가능하도록 해서 보안 높여야함
- httpOnly 옵션으로 XSS 공격을 예방해야함
- sameSite 옵션으로 CSRF 공격을 예방해야함
